# ðŸš€ SAGA Pattern - Hands-On Egzersizler

Bu bÃ¶lÃ¼mde SAGA Pattern implementation'Ä±nÄ± hands-on olarak test edeceÄŸiz.

## ðŸŽ¯ Egzersiz 1: Order Processing SAGA Testi

### Test SenaryolarÄ±

#### **Senaryo 1: Happy Path - BaÅŸarÄ±lÄ± Order Processing**

````java
// test/integration/OrderProcessingSagaHappyPathTest.java
package com.example.saga.integration;

import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.TestPropertySource;
import org.testcontainers.junit.jupiter.Testcontainers;

/**
 * Order Processing SAGA Happy Path Integration Test
 *
 * BaÅŸarÄ±lÄ± order flow'unu end-to-end test eder.
 */
@SpringBootTest
@Testcontainers
@TestPropertySource(properties = {
    "spring.datasource.url=jdbc:h2:mem:testdb",
    "spring.kafka.bootstrap-servers=${kafka.bootstrapServers}"
})
class OrderProcessingSagaHappyPathTest extends SagaIntegrationTestBase {

    @Test
    void shouldCompleteOrderProcessingSuccessfully() {
        // Given: Valid order data
        OrderPlacedEvent orderEvent = OrderPlacedEvent.builder()
            .orderId("ORD-2024-001")
            .customerId("CUST-123")
            .items(List.of(
                OrderItem.builder()
                    .productId("PROD-456")
                    .quantity(2)
                    .unitPrice(BigDecimal.valueOf(29.99))
                    .build(),
                OrderItem.builder()
                    .productId("PROD-789")
                    .quantity(1)
                    .unitPrice(BigDecimal.valueOf(49.99))
                    .build()
            ))
            .totalAmount(BigDecimal.valueOf(109.97))
            .currency("USD")
            .paymentMethod("CREDIT_CARD")
            .shippingAddress(Address.builder()
                .street("123 Main St")
                .city("New York")
                .zipCode("10001")
                .country("USA")
                .build())
            .occurredAt(LocalDateTime.now())
            .build();\n        \n        // When: SAGA baÅŸlatÄ±lÄ±r\n        sagaOrchestrator.startOrderProcessingSaga(orderEvent);\n        \n        // Then: SAGA execution baÅŸlatÄ±lÄ±r\n        await().atMost(Duration.ofSeconds(5)).untilAsserted(() -> {\n            Optional<SagaExecution> sagaOpt = sagaExecutionRepository\n                .findByOrderId(OrderId.from(orderEvent.getOrderId()));\n            \n            assertThat(sagaOpt).isPresent();\n            assertThat(sagaOpt.get().getState()).isEqualTo(SagaState.INVENTORY_CHECKING);\n        });\n        \n        // Mock inventory service success response\n        mockInventoryCheckSuccess(orderEvent);\n        \n        // Wait for inventory check completion\n        await().atMost(Duration.ofSeconds(5)).untilAsserted(() -> {\n            SagaExecution saga = findSagaByOrderId(orderEvent.getOrderId());\n            assertThat(saga.getState()).isEqualTo(SagaState.PAYMENT_PROCESSING);\n        });\n        \n        // Mock payment service success response\n        mockPaymentProcessSuccess(orderEvent);\n        \n        // Wait for payment completion\n        await().atMost(Duration.ofSeconds(5)).untilAsserted(() -> {\n            SagaExecution saga = findSagaByOrderId(orderEvent.getOrderId());\n            assertThat(saga.getState()).isEqualTo(SagaState.INVENTORY_RESERVING);\n        });\n        \n        // Mock inventory reservation success\n        mockInventoryReservationSuccess(orderEvent);\n        \n        // Wait for final completion\n        await().atMost(Duration.ofSeconds(10)).untilAsserted(() -> {\n            SagaExecution saga = findSagaByOrderId(orderEvent.getOrderId());\n            assertThat(saga.getState()).isEqualTo(SagaState.COMPLETED);\n            assertThat(saga.getResult()).isEqualTo(SagaResult.SUCCESS);\n            assertThat(saga.getCompletedAt()).isNotNull();\n        });\n        \n        // Verify final state\n        SagaExecution completedSaga = findSagaByOrderId(orderEvent.getOrderId());\n        \n        assertThat(completedSaga.getDuration()).isLessThan(Duration.ofMinutes(1));\n        assertThat(completedSaga.getRetryCount()).isEqualTo(0);\n        assertThat(completedSaga.getErrorMessage()).isNull();\n        \n        // Verify all services were called\n        verify(inventoryService).checkAvailability(any(InventoryCheckCommand.class));\n        verify(paymentService).processPayment(any(ProcessPaymentCommand.class));\n        verify(inventoryService).reserveItems(any(ReserveItemsCommand.class));\n        \n        log.info(\"âœ… Happy path test completed successfully!\");\n    }\n    \n    private void mockInventoryCheckSuccess(OrderPlacedEvent orderEvent) {\n        InventoryCheckedEvent event = InventoryCheckedEvent.builder()\n            .orderId(orderEvent.getOrderId())\n            .allItemsAvailable(true)\n            .reservationId(\"INV-RES-001\")\n            .expiresAt(LocalDateTime.now().plusMinutes(15))\n            .occurredAt(LocalDateTime.now())\n            .build();\n        \n        eventPublisher.publishEvent(event);\n    }\n    \n    private void mockPaymentProcessSuccess(OrderPlacedEvent orderEvent) {\n        PaymentProcessedEvent event = PaymentProcessedEvent.builder()\n            .orderId(orderEvent.getOrderId())\n            .paymentId(\"PAY-001\")\n            .amount(orderEvent.getTotalAmount())\n            .currency(orderEvent.getCurrency())\n            .status(PaymentStatus.COMPLETED)\n            .transactionId(\"TXN-123456\")\n            .occurredAt(LocalDateTime.now())\n            .build();\n        \n        eventPublisher.publishEvent(event);\n    }\n    \n    private void mockInventoryReservationSuccess(OrderPlacedEvent orderEvent) {\n        InventoryReservedEvent event = InventoryReservedEvent.builder()\n            .orderId(orderEvent.getOrderId())\n            .reservationId(\"INV-RES-001\")\n            .items(orderEvent.getItems().stream()\n                .map(item -> ReservedItem.builder()\n                    .productId(item.getProductId())\n                    .quantity(item.getQuantity())\n                    .reservedAt(LocalDateTime.now())\n                    .build())\n                .collect(Collectors.toList()))\n            .expiresAt(LocalDateTime.now().plusHours(2))\n            .occurredAt(LocalDateTime.now())\n            .build();\n        \n        eventPublisher.publishEvent(event);\n    }\n}\n```\n\n#### **Senaryo 2: Payment Failure - Compensation Flow**\n\n```java\n// test/integration/OrderProcessingSagaCompensationTest.java\npackage com.example.saga.integration;\n\n/**\n * Order Processing SAGA Compensation Flow Test\n * \n * Payment failure durumunda compensation flow'unu test eder.\n */\n@SpringBootTest\n@Testcontainers\nclass OrderProcessingSagaCompensationTest extends SagaIntegrationTestBase {\n    \n    @Test\n    void shouldCompensateWhenPaymentFails() {\n        // Given: Valid order with inventory available\n        OrderPlacedEvent orderEvent = createValidOrderEvent();\n        \n        // When: SAGA baÅŸlatÄ±lÄ±r ve inventory check baÅŸarÄ±lÄ±\n        sagaOrchestrator.startOrderProcessingSaga(orderEvent);\n        \n        // Inventory check success\n        await().atMost(Duration.ofSeconds(5)).untilAsserted(() -> {\n            SagaExecution saga = findSagaByOrderId(orderEvent.getOrderId());\n            assertThat(saga.getState()).isEqualTo(SagaState.INVENTORY_CHECKING);\n        });\n        \n        mockInventoryCheckSuccess(orderEvent);\n        \n        // Payment processing baÅŸlar\n        await().atMost(Duration.ofSeconds(5)).untilAsserted(() -> {\n            SagaExecution saga = findSagaByOrderId(orderEvent.getOrderId());\n            assertThat(saga.getState()).isEqualTo(SagaState.PAYMENT_PROCESSING);\n        });\n        \n        // Then: Payment fails\n        mockPaymentFailure(orderEvent);\n        \n        // Compensation baÅŸlamalÄ±\n        await().atMost(Duration.ofSeconds(10)).untilAsserted(() -> {\n            SagaExecution saga = findSagaByOrderId(orderEvent.getOrderId());\n            assertThat(saga.getState()).isEqualTo(SagaState.COMPENSATING);\n        });\n        \n        // Inventory compensation success\n        mockInventoryCompensationSuccess(orderEvent);\n        \n        // Final compensation state\n        await().atMost(Duration.ofSeconds(10)).untilAsserted(() -> {\n            SagaExecution saga = findSagaByOrderId(orderEvent.getOrderId());\n            assertThat(saga.getState()).isEqualTo(SagaState.COMPLETED);\n            assertThat(saga.getResult()).isEqualTo(SagaResult.COMPENSATED);\n        });\n        \n        // Verify compensation actions\n        SagaExecution compensatedSaga = findSagaByOrderId(orderEvent.getOrderId());\n        \n        assertThat(compensatedSaga.getErrorMessage()).contains(\"Payment failed\");\n        assertThat(compensatedSaga.getCompletedAt()).isNotNull();\n        \n        // Verify compensation commands were sent\n        verify(inventoryService).releaseReservation(any(ReleaseReservationCommand.class));\n        \n        log.info(\"âœ… Compensation flow test completed successfully!\");\n    }\n    \n    private void mockPaymentFailure(OrderPlacedEvent orderEvent) {\n        PaymentFailedEvent event = PaymentFailedEvent.builder()\n            .orderId(orderEvent.getOrderId())\n            .reason(\"Insufficient funds\")\n            .errorCode(\"PAYMENT_DECLINED\")\n            .attemptedAmount(orderEvent.getTotalAmount())\n            .currency(orderEvent.getCurrency())\n            .occurredAt(LocalDateTime.now())\n            .build();\n        \n        eventPublisher.publishEvent(event);\n    }\n    \n    private void mockInventoryCompensationSuccess(OrderPlacedEvent orderEvent) {\n        InventoryReleasedEvent event = InventoryReleasedEvent.builder()\n            .orderId(orderEvent.getOrderId())\n            .reservationId(\"INV-RES-001\")\n            .releasedItems(orderEvent.getItems().stream()\n                .map(item -> ReleasedItem.builder()\n                    .productId(item.getProductId())\n                    .quantity(item.getQuantity())\n                    .releasedAt(LocalDateTime.now())\n                    .build())\n                .collect(Collectors.toList()))\n            .occurredAt(LocalDateTime.now())\n            .build();\n        \n        eventPublisher.publishEvent(event);\n    }\n}\n```\n\n#### **Senaryo 3: Timeout Handling**\n\n```java\n/**\n * SAGA Timeout Handling Test\n * \n * Service response timeout durumlarÄ±nÄ± test eder.\n */\n@Test\nvoid shouldHandleServiceTimeouts() {\n    // Given: Order event\n    OrderPlacedEvent orderEvent = createValidOrderEvent();\n    \n    // When: SAGA baÅŸlatÄ±lÄ±r\n    sagaOrchestrator.startOrderProcessingSaga(orderEvent);\n    \n    // Inventory check baÅŸlar ama response gelmez\n    await().atMost(Duration.ofSeconds(5)).untilAsserted(() -> {\n        SagaExecution saga = findSagaByOrderId(orderEvent.getOrderId());\n        assertThat(saga.getState()).isEqualTo(SagaState.INVENTORY_CHECKING);\n    });\n    \n    // Timeout period'u geÃ§ (30 saniye simÃ¼le)\n    testClock.advance(Duration.ofSeconds(35));\n    \n    // Timeout handler Ã§alÄ±ÅŸmalÄ±\n    await().atMost(Duration.ofSeconds(10)).untilAsserted(() -> {\n        SagaExecution saga = findSagaByOrderId(orderEvent.getOrderId());\n        assertThat(saga.getState()).isEqualTo(SagaState.FAILED);\n        assertThat(saga.getResult()).isEqualTo(SagaResult.TIMEOUT);\n        assertThat(saga.getErrorMessage()).contains(\"Timeout\");\n    });\n    \n    log.info(\"âœ… Timeout handling test completed successfully!\");\n}\n```\n\n## ðŸŽ¯ Egzersiz 2: SAGA Monitoring Testi\n\n### Dashboard Functionality Test\n\n```java\n// test/integration/SagaMonitoringTest.java\npackage com.example.saga.integration;\n\n/**\n * SAGA Monitoring & Dashboard Test\n */\n@SpringBootTest\nclass SagaMonitoringTest extends SagaIntegrationTestBase {\n    \n    @Autowired\n    private SagaDashboardService dashboardService;\n    \n    @Autowired\n    private SagaMetricsCollector metricsCollector;\n    \n    @Test\n    void shouldProvideComprehensiveDashboardData() {\n        // Given: Multiple SAGA executions\n        createMultipleSagaExecutions();\n        \n        // When: Dashboard data istenir\n        SagaDashboardData dashboardData = dashboardService.getDashboardData();\n        \n        // Then: DoÄŸru metrics saÄŸlanÄ±r\n        assertThat(dashboardData.getTotalSagas()).isGreaterThan(0);\n        assertThat(dashboardData.getActiveSagas()).isEqualTo(2);\n        assertThat(dashboardData.getCompletedSagas()).isEqualTo(3);\n        assertThat(dashboardData.getFailedSagas()).isEqualTo(1);\n        assertThat(dashboardData.getSuccessRate()).isBetween(60.0, 80.0);\n        \n        assertThat(dashboardData.getPerformanceMetrics()).isNotNull();\n        assertThat(dashboardData.getPerformanceMetrics().getP95ExecutionTime())\n            .isLessThan(Duration.ofMinutes(5));\n        \n        log.info(\"âœ… Dashboard data test completed!\");\n    }\n    \n    @Test\n    void shouldDetectProblematicSagas() {\n        // Given: Long running SAGA\n        SagaExecution longRunningSaga = createLongRunningSaga();\n        \n        // When: Health check Ã§alÄ±ÅŸÄ±r\n        List<SagaHealthAlert> alerts = dashboardService.detectProblematicSagas();\n        \n        // Then: Alert detect edilir\n        assertThat(alerts)\n            .hasSize(1)\n            .first()\n            .satisfies(alert -> {\n                assertThat(alert.getAlertType()).isEqualTo(SagaAlertType.LONG_RUNNING);\n                assertThat(alert.getSeverity()).isEqualTo(AlertSeverity.WARNING);\n                assertThat(alert.getSagaId()).isEqualTo(longRunningSaga.getId());\n            });\n        \n        log.info(\"âœ… Problem detection test completed!\");\n    }\n    \n    @Test\n    void shouldAllowSagaRetry() {\n        // Given: Failed SAGA\n        SagaExecution failedSaga = createFailedSaga();\n        \n        // When: Retry iÅŸlemi\n        SagaRetryResult result = dashboardService.retrySaga(\n            failedSaga.getId(), \n            \"Manual retry - investigating payment issue\"\n        );\n        \n        // Then: Retry baÅŸarÄ±lÄ±\n        assertThat(result.isSuccess()).isTrue();\n        assertThat(result.getMessage()).contains(\"queued for retry\");\n        \n        // SAGA state gÃ¼ncellenmiÅŸ olmalÄ±\n        await().atMost(Duration.ofSeconds(5)).untilAsserted(() -> {\n            SagaExecution saga = sagaExecutionRepository.findById(failedSaga.getId()).get();\n            assertThat(saga.getRetryCount()).isEqualTo(1);\n            assertThat(saga.getState()).isEqualTo(SagaState.STARTED);\n        });\n        \n        log.info(\"âœ… SAGA retry test completed!\");\n    }\n    \n    private void createMultipleSagaExecutions() {\n        // 3 successful, 1 failed, 2 active SAGAs\n        for (int i = 0; i < 6; i++) {\n            OrderPlacedEvent event = OrderPlacedEvent.builder()\n                .orderId(\"ORD-\" + i)\n                .customerId(\"CUST-\" + i)\n                .items(List.of(createOrderItem()))\n                .totalAmount(BigDecimal.valueOf(100))\n                .currency(\"USD\")\n                .paymentMethod(\"CREDIT_CARD\")\n                .shippingAddress(createAddress())\n                .occurredAt(LocalDateTime.now().minusHours(i))\n                .build();\n            \n            SagaExecution saga = SagaExecution.start(event);\n            \n            if (i < 3) {\n                // Completed successfully\n                saga.moveToState(SagaState.COMPLETED);\n                saga.setResult(SagaResult.SUCCESS);\n                saga.setCompletedAt(LocalDateTime.now().minusMinutes(30 - i * 10));\n            } else if (i == 3) {\n                // Failed\n                saga.moveToState(SagaState.FAILED);\n                saga.setResult(SagaResult.FAILURE);\n                saga.setErrorMessage(\"Payment service unavailable\");\n                saga.setCompletedAt(LocalDateTime.now().minusMinutes(15));\n            }\n            // i >= 4: Active SAGAs (default state)\n            \n            sagaExecutionRepository.save(saga);\n        }\n    }\n    \n    private SagaExecution createLongRunningSaga() {\n        OrderPlacedEvent event = createValidOrderEvent();\n        SagaExecution saga = SagaExecution.start(event);\n        saga.setStartedAt(LocalDateTime.now().minusHours(3)); // 3 hours ago\n        saga.setLastActivityAt(LocalDateTime.now().minusMinutes(30)); // Inactive\n        \n        return sagaExecutionRepository.save(saga);\n    }\n    \n    private SagaExecution createFailedSaga() {\n        OrderPlacedEvent event = createValidOrderEvent();\n        SagaExecution saga = SagaExecution.start(event);\n        saga.moveToState(SagaState.FAILED);\n        saga.setResult(SagaResult.FAILURE);\n        saga.setErrorMessage(\"Payment processing failed\");\n        saga.setCompletedAt(LocalDateTime.now().minusMinutes(10));\n        \n        return sagaExecutionRepository.save(saga);\n    }\n}\n```\n\n## ðŸŽ¯ Egzersiz 3: Performance & Load Testing\n\n### Concurrent SAGA Execution Test\n\n```java\n// test/performance/SagaPerformanceTest.java\npackage com.example.saga.performance;\n\nimport org.junit.jupiter.api.Test;\nimport org.junit.jupiter.api.Disabled;\n\n/**\n * SAGA Performance & Load Test\n * \n * Production-like load conditions altÄ±nda SAGA performance'Ä±nÄ± test eder.\n */\n@SpringBootTest\n@Disabled(\"Performance test - run manually\")\nclass SagaPerformanceTest extends SagaIntegrationTestBase {\n    \n    @Test\n    void shouldHandleConcurrentSagaExecutions() throws InterruptedException {\n        int sagaCount = 100;\n        int concurrency = 10;\n        ExecutorService executor = Executors.newFixedThreadPool(concurrency);\n        CountDownLatch latch = new CountDownLatch(sagaCount);\n        \n        List<String> orderIds = new ArrayList<>();\n        \n        // Given: Concurrent SAGA baÅŸlatma\n        long startTime = System.currentTimeMillis();\n        \n        for (int i = 0; i < sagaCount; i++) {\n            final int index = i;\n            executor.submit(() -> {\n                try {\n                    OrderPlacedEvent event = OrderPlacedEvent.builder()\n                        .orderId(\"LOAD-ORD-\" + index)\n                        .customerId(\"CUST-\" + (index % 50)) // 50 different customers\n                        .items(createRandomOrderItems())\n                        .totalAmount(BigDecimal.valueOf(50 + (index % 200)))\n                        .currency(\"USD\")\n                        .paymentMethod(\"CREDIT_CARD\")\n                        .shippingAddress(createAddress())\n                        .occurredAt(LocalDateTime.now())\n                        .build();\n                    \n                    synchronized (orderIds) {\n                        orderIds.add(event.getOrderId());\n                    }\n                    \n                    sagaOrchestrator.startOrderProcessingSaga(event);\n                    \n                } catch (Exception e) {\n                    log.error(\"Error starting SAGA {}\", index, e);\n                } finally {\n                    latch.countDown();\n                }\n            });\n        }\n        \n        // Wait for all SAGAs to start\n        latch.await(30, TimeUnit.SECONDS);\n        executor.shutdown();\n        \n        long allStartedTime = System.currentTimeMillis();\n        log.info(\"All {} SAGAs started in {} ms\", \n                sagaCount, (allStartedTime - startTime));\n        \n        // When: Mock all service responses for success\n        mockAllServicesForSuccess(orderIds);\n        \n        // Then: Wait for all SAGAs to complete\n        await().atMost(Duration.ofMinutes(5)).untilAsserted(() -> {\n            long completedCount = orderIds.stream()\n                .mapToLong(orderId -> {\n                    Optional<SagaExecution> sagaOpt = sagaExecutionRepository\n                        .findByOrderId(OrderId.from(orderId));\n                    return sagaOpt\n                        .filter(saga -> saga.getState().isFinalState())\n                        .map(saga -> 1L)\n                        .orElse(0L);\n                })\n                .sum();\n            \n            assertThat(completedCount).isEqualTo(sagaCount);\n        });\n        \n        long allCompletedTime = System.currentTimeMillis();\n        log.info(\"All {} SAGAs completed in {} ms\", \n                sagaCount, (allCompletedTime - startTime));\n        \n        // Performance assertions\n        List<SagaExecution> completedSagas = orderIds.stream()\n            .map(orderId -> sagaExecutionRepository.findByOrderId(OrderId.from(orderId)).get())\n            .collect(Collectors.toList());\n        \n        // Success rate should be high\n        long successCount = completedSagas.stream()\n            .filter(saga -> saga.getResult() == SagaResult.SUCCESS)\n            .count();\n        \n        double successRate = (double) successCount / sagaCount;\n        assertThat(successRate).isGreaterThan(0.95); // 95% success rate\n        \n        // Average execution time should be reasonable\n        Duration avgExecutionTime = Duration.ofMillis(\n            (long) completedSagas.stream()\n                .filter(saga -> saga.getDuration() != null)\n                .mapToLong(saga -> saga.getDuration().toMillis())\n                .average()\n                .orElse(0)\n        );\n        \n        assertThat(avgExecutionTime).isLessThan(Duration.ofMinutes(2));\n        \n        log.info(\"âœ… Performance test completed!\");\n        log.info(\"   Success rate: {:.1f}%\", successRate * 100);\n        log.info(\"   Average execution time: {} ms\", avgExecutionTime.toMillis());\n        log.info(\"   Total test time: {} ms\", (allCompletedTime - startTime));\n    }\n    \n    private void mockAllServicesForSuccess(List<String> orderIds) {\n        // Background thread'de tÃ¼m order'lar iÃ§in success response'larÄ± gÃ¶nder\n        CompletableFuture.runAsync(() -> {\n            for (String orderId : orderIds) {\n                try {\n                    Thread.sleep(100 + new Random().nextInt(500)); // 100-600ms delay\n                    \n                    // Inventory check success\n                    eventPublisher.publishEvent(InventoryCheckedEvent.builder()\n                        .orderId(orderId)\n                        .allItemsAvailable(true)\n                        .reservationId(\"INV-\" + orderId)\n                        .expiresAt(LocalDateTime.now().plusMinutes(15))\n                        .occurredAt(LocalDateTime.now())\n                        .build());\n                    \n                    Thread.sleep(100 + new Random().nextInt(300)); // Payment delay\n                    \n                    // Payment success\n                    eventPublisher.publishEvent(PaymentProcessedEvent.builder()\n                        .orderId(orderId)\n                        .paymentId(\"PAY-\" + orderId)\n                        .amount(BigDecimal.valueOf(100))\n                        .currency(\"USD\")\n                        .status(PaymentStatus.COMPLETED)\n                        .transactionId(\"TXN-\" + orderId)\n                        .occurredAt(LocalDateTime.now())\n                        .build());\n                    \n                    Thread.sleep(50 + new Random().nextInt(200)); // Reservation delay\n                    \n                    // Inventory reservation success\n                    eventPublisher.publishEvent(InventoryReservedEvent.builder()\n                        .orderId(orderId)\n                        .reservationId(\"INV-\" + orderId)\n                        .items(List.of(\n                            ReservedItem.builder()\n                                .productId(\"PROD-123\")\n                                .quantity(1)\n                                .reservedAt(LocalDateTime.now())\n                                .build()\n                        ))\n                        .expiresAt(LocalDateTime.now().plusHours(2))\n                        .occurredAt(LocalDateTime.now())\n                        .build());\n                        \n                } catch (InterruptedException e) {\n                    Thread.currentThread().interrupt();\n                    break;\n                } catch (Exception e) {\n                    log.error(\"Error mocking responses for order {}\", orderId, e);\n                }\n            }\n        });\n    }\n    \n    private List<OrderItem> createRandomOrderItems() {\n        Random random = new Random();\n        int itemCount = 1 + random.nextInt(3); // 1-3 items\n        \n        List<OrderItem> items = new ArrayList<>();\n        for (int i = 0; i < itemCount; i++) {\n            items.add(OrderItem.builder()\n                .productId(\"PROD-\" + (100 + random.nextInt(900)))\n                .quantity(1 + random.nextInt(3))\n                .unitPrice(BigDecimal.valueOf(10 + random.nextInt(100)))\n                .build());\n        }\n        \n        return items;\n    }\n}\n```\n\n## ðŸŽ¯ Egzersiz 4: Production Readiness Test\n\n### Circuit Breaker & Resilience Test\n\n```java\n/**\n * SAGA Resilience Test\n * \n * Production failure scenarios'Ä±nÄ± test eder.\n */\n@Test\nvoid shouldHandleServiceUnavailability() {\n    // Given: Service circuit breaker aÃ§Ä±k\n    circuitBreakerRegistry.circuitBreaker(\"inventory-service\")\n        .transitionToOpenState();\n    \n    OrderPlacedEvent orderEvent = createValidOrderEvent();\n    \n    // When: SAGA baÅŸlatÄ±lÄ±r\n    sagaOrchestrator.startOrderProcessingSaga(orderEvent);\n    \n    // Then: Circuit breaker nedeniyle hemen fail olmalÄ±\n    await().atMost(Duration.ofSeconds(10)).untilAsserted(() -> {\n        SagaExecution saga = findSagaByOrderId(orderEvent.getOrderId());\n        assertThat(saga.getState()).isEqualTo(SagaState.FAILED);\n        assertThat(saga.getErrorMessage()).contains(\"Circuit breaker\");\n    });\n    \n    log.info(\"âœ… Circuit breaker test completed!\");\n}\n\n@Test\nvoid shouldHandleDatabaseConnectionLoss() {\n    // Given: SAGA execution baÅŸlatÄ±lmÄ±ÅŸ\n    OrderPlacedEvent orderEvent = createValidOrderEvent();\n    sagaOrchestrator.startOrderProcessingSaga(orderEvent);\n    \n    // Database connection simulation loss\n    // (This would be done through testcontainers network partitioning)\n    \n    // When: Database reconnects\n    // SAGA should recover and continue\n    \n    // Then: SAGA eventually completes\n    // Implementation would depend on specific resilience mechanisms\n    \n    log.info(\"âœ… Database resilience test completed!\");\n}\n```\n\n---\n\n## ðŸš€ Test Execution Guide\n\n### 1. **Development Environment Setup**\n\n```bash\n# Terminal 1: Start test infrastructure\ndocker-compose -f docker-compose.test.yml up -d\n\n# Terminal 2: Run integration tests\n./mvnw test -Dtest=\"*SagaIntegrationTest\"\n\n# Terminal 3: Monitor test execution\ndocker logs -f saga-test-kafka\n```\n\n### 2. **Test Categories**\n\n```bash\n# Unit tests\n./mvnw test -Dtest=\"*UnitTest\"\n\n# Integration tests\n./mvnw test -Dtest=\"*IntegrationTest\"\n\n# Performance tests (manual)\n./mvnw test -Dtest=\"SagaPerformanceTest\" -DskipTests=false\n\n# All SAGA tests\n./mvnw test -Dtest=\"*Saga*Test\"\n```\n\n### 3. **Test Data Verification**\n\n```sql\n-- SAGA execution verification\nSELECT \n    saga_id,\n    order_id,\n    state,\n    result,\n    started_at,\n    completed_at,\n    duration_ms,\n    retry_count,\n    error_message\nFROM saga_executions \nWHERE started_at > NOW() - INTERVAL 1 HOUR\nORDER BY started_at DESC;\n\n-- State transition audit\nSELECT \n    saga_id,\n    from_state,\n    to_state,\n    transition_timestamp,\n    duration_ms,\n    error_message\nFROM saga_state_transitions \nWHERE saga_id = 'SAGA-ID'\nORDER BY transition_timestamp;\n```\n\n### 4. **Monitoring During Tests**\n\n```bash\n# Kafka messages monitoring\nkafka-console-consumer.sh \\\n    --bootstrap-server localhost:9092 \\\n    --topic saga-events \\\n    --from-beginning\n\n# Application logs\ntail -f logs/saga-application.log | grep \"SAGA\"\n\n# Database connections\nselect count(*) from pg_stat_activity where state = 'active';\n```\n\nBu hands-on egzersizler ile SAGA Pattern implementation'Ä±nÄ±zÄ± thoroughly test edebilir ve production readiness'Ä±nÄ± validate edebilirsiniz! ðŸŽ¯\n\n**Sonraki AdÄ±m:** Outbox Pattern implementation'Ä± ile reliable event publishing! ðŸš€
````
